# Day 2-2 | 要件確認 × システム設計の出発点 (2): ドメイン境界と基本要件の確認

昨日、私たちはユーザーの言葉から機能要件の本質を抽出し、異なる認知モデルの下でシステムの存在目的を理解しました。しかし、これらの抽象的な理解を具体的なAWSアーキテクチャに変換しようとすると、重要な問題に気づくでしょう:

**機能要件は「何をすべきか」を答えますが、「どの程度まで」は答えません。**

投資取引ユーザーが「速度が遅いと損失を被る可能性がある」と言うとき、実際には遅延を何ミリ秒以内に制御すべきかを意味しているのでしょうか?家計管理ユーザーが「いつでも支出を整理する」と言うとき、システムは何人の同時ユーザーをサポートすべきでしょうか?健康モニタリングユーザーが「判断に影響を与えることはできない」と言うとき、許容できるダウンタイムはどれくらいでしょうか?

これらは**非機能要件**の領域であり、システムの技術的境界とAWSサービスの具体的な構成を決定します。

## 非機能要件の存在論: 定性から定量への変換

### 技術的境界の3つのレベル

**パフォーマンス境界**

- 1秒あたりのAPIリクエスト数(RPS)の上限と下限
- レスポンスタイムの期待値と許容範囲
- データ処理スループットのピーク値と平均値

**容量境界**

- ユーザー成長の期待曲線とピーク計画
- データストレージの成長モデルと履歴保持
- コンピューティングリソースの弾性拡張とコスト管理

**レジリエンス境界**

- 許容可能な目標復旧時間(RTO)
- 許容可能な目標復旧時点(RPO)
- システムの段階的劣化の適切な範囲とコア機能の保証

### ドメインイベントからの技術仕様の導出

各ドメインには独自の**技術的リズム**があり、それがシステムのパフォーマンス特性を決定します:

**金融取引ドメイン**: マイクロ秒レベルの競争リズム

- 市場データの更新: 毎秒数千回
- 取引決定の遅延: ミリ秒は許容できない
- ポジション計算の精度: 小数点以下8桁

**家族管理ドメイン**: 日常生活の協調リズム

- 支出記録の頻度: 1日に数回から数十回
- 同期遅延の許容度: 秒単位は許容可能
- データ整合性の要件: 結果整合性で十分

**健康モニタリングドメイン**: 生理的サイクルの監視リズム

- デバイスデータの同期: 数分から数時間
- 異常アラームの遅延: 重要な指標はリアルタイムである必要がある
- 履歴データの保存: 年単位の長期保存

## 1秒あたりのAPIリクエスト: ユーザー行動から技術指標へ

### RPSの哲学的基礎

RPSは何気なく推定された数字ではなく、ユーザー行動パターンから導き出された必然的な結果です。すべてのAPI呼び出しの背後にはユーザーの意図があり、ユーザー意図の頻度分布がシステムの負荷特性を決定します。

#### 投資取引システムのRPS導出

**ユーザー行動パターン分析**:

**行動の階層化**:

- 一般投資家: 1日に2〜5回ポジションを確認、0〜2回取引
- アクティブトレーダー: 1日に20〜50回ポジションを確認、5〜15回取引
- 高頻度トレーダー: 毎秒ポジションを確認、毎分取引する可能性がある

**時間分布**:

- 市場開場の30分前: トラフィックがピーク、通常の10倍
- 取引セッション: 継続的な高トラフィック、通常の5倍
- 市場閉場後: 徐々にベースラインに戻る

**計算ロジック**:

- 一般ユーザー: 5 API呼び出し/日 ÷ 8時間 = 0.17 RPS/ユーザー
- アクティブユーザー: 50 API呼び出し/日 ÷ 8時間 = 1.74 RPS/ユーザー
- 高頻度ユーザー: 3600 API呼び出し/時 ÷ 3600秒 = 60 RPS/ユーザー
- ユーザー分布を仮定: 80%一般、15%アクティブ、5%高頻度
- 合計RPS = (0.8 × 0.17 + 0.15 × 1.74 + 0.05 × 60) × 総ユーザー数
- = (0.136 + 0.261 + 3) × 総ユーザー数
- = 3.397 × 総ユーザー数

**AWSサービス選択のためのRPS閾値**:

- < 100 RPS: API Gateway + Lambda (サーバーレス優先)
- 100-1000 RPS: ALB + ECS/EC2 (コンテナまたはVM)
- 1000-10000 RPS: ALB + Auto Scaling Groups
- > 10000 RPS: カスタムロードバランサー + マルチAZデプロイメント

#### 家計管理システムのRPS導出

**協調行動の時間的集約**:

**家族協調モデル**:

- 1家族あたり平均3.5人、頻繁なユーザーは2人
- 集中使用期間: 夕食後(19:00-21:00)、週末のショッピング期間
- 協調の衝突: 複数人が同時に同じ支出を記録する確率

**計算ロジック**:

- 平日の夜: 2ユーザー/家族 × 5記録/2時間 = 2.5 RPS/家族/1000家族
- 週末のピーク: 2.5 × 3 = 7.5 RPS/1000家族
- 年間税務シーズン: 7.5 × 2 = 15 RPS/1000家族

#### 健康モニタリングシステムのRPS導出

**IoTデバイスのデータプッシュモデル**:

**デバイスタイプと頻度**:

- スマートブレスレット: 30秒ごとに心拍数、10分ごとに歩数
- 血圧計: 手動測定、1日1〜3回
- 血糖計: 手動測定、1日2〜6回
- スマート体重計: 手動測定、週に2〜3回

**計算ロジック**:

- ブレスレット: (120 + 6) API呼び出し/日 = 126/日 = 0.0015 RPS/ユーザー
- 血圧計: 3 API呼び出し/日 = 0.000035 RPS/ユーザー
- 血糖計: 6 API呼び出し/日 = 0.00007 RPS/ユーザー
- 体重計: 0.4 API呼び出し/日 = 0.000005 RPS/ユーザー
- 合計: ≈ 0.002 RPS/ユーザー
- ただし、データ同期のバッチ処理と例外時の再試行を考慮:
- 実際のRPS = 0.002 × リトライ係数 × バッチ係数 ≈ 0.01 RPS/ユーザー

### API設計の哲学: インターフェースから契約へ

APIは単なる技術的インターフェースではなく、**ドメイン概念のプログラム的表現**です。各APIエンドポイントは、ドメイン内の意味のある操作に対応する必要があります。

**RESTfulドメイン意味論のマッピング**:

**投資取引ドメイン**:

- POST /portfolios/{id}/orders - 取引注文を送信
- GET /portfolios/{id}/positions - ポジション状態を照会
- PATCH /accounts/{id}/risk-preferences - リスク選好を更新
- GET /market/quotes/{symbol} - 市場相場を取得

**家計管理ドメイン**:

- POST /families/{id}/expenses - 支出を記録
- GET /families/{id}/budget/status - 予算状態を照会
- PUT /families/{id}/members/{member_id}/permissions - 権限を設定
- GET /families/{id}/reports/{period} - 財務レポートを生成

**AWS API Gatewayスロットリング戦略**:

```yaml
ThrottlingSettings:
  BurstLimit: 5000 # バーストトラフィック制限
  RateLimit: 2000 # 定常状態トラフィック制限

UsagePlan:
  BasicTier:
    Throttle: { BurstLimit: 100, RateLimit: 50 }
    Quota: { Limit: 1000, Period: DAY }
  PremiumTier:
    Throttle: { BurstLimit: 1000, RateLimit: 500 }
    Quota: { Limit: 10000, Period: DAY }
```

## 容量計画: 成長パターンのシステム思考

### ビジネス成長のパターン認識

異なるビジネスには異なる成長曲線があり、これは容量計画戦略に直接影響します:

**線形成長モデル(家計管理)**

- 特徴: 安定したユーザー成長、予測可能な使用パターン
- 成長関数: capacity(t) = baseline + growth_rate × t
- AWS戦略: リザーブドインスタンス + 予測可能なスケーリング
- コスト最適化: 長期的なコミットメントと引き換えにコスト削減

**指数関数的成長モデル(ソーシャル共有プラットフォーム)**

- 特徴: バイラル拡散、非常に変動の激しいトラフィック
- 成長関数: capacity(t) = baseline × (1 + growth_rate)^t
- AWS戦略: サーバーレス + Auto Scaling + スポットインスタンス
- コスト最適化: 従量課金、迅速な弾性スケーリング

**周期的成長モデル(投資取引システム)**

- 特徴: 外部サイクルと高度に相関(市場開場時間)
- 成長関数: capacity(t) = baseline + seasonal_factor × sin(2π × t/period)
- AWS戦略: スケジュールドスケーリング + 予測的スケーリング
- コスト最適化: 予測的スケーリングで突然のトラフィックスパイクを回避

### ストレージ容量のライフサイクル管理

**データの時間的価値減衰**:

各タイプのデータには独自の時間的重要性とアクセスパターンがあります:

**投資取引データのライフサイクル**:

- リアルタイムデータ(1時間以内): 非常に高いアクセス頻度 → S3 Standard
- 当日データ(24時間以内): 高いアクセス頻度 → S3 Standard
- 履歴データ(30日以内): 中程度のアクセス頻度 → S3 IA
- 四半期レポート(1年以内): 低いアクセス頻度 → S3 Glacier
- 規制アーカイブ(7年以内): 非常に低いアクセス頻度 → S3 Deep Archive

**健康モニタリングデータのライフサイクル**:

- 現在のメトリクス(1日以内): ユーザーが毎日確認 → S3 Standard
- 定期的なトレンド(30日以内): 定期的な分析 → S3 IA
- 年間記録(1年以内): 年次健康診断のための比較 → S3 Glacier
- 長期履歴(生涯): 医学研究価値 → S3 Deep Archive

**S3ストレージクラスのコスト便益分析**:

**ストレージコスト(GB/月あたり)**:

- Standard: $0.023
- IA: $0.0125 (ストレージは45%安いが、取得コストは高い)
- Glacier: $0.004 (ストレージは83%安いが、取得には数時間かかる)
- Deep Archive: $0.00099 (ストレージは96%安いが、取得には12時間かかる)

**アクセスパターンのコスト閾値**:

- >1アクセス/月 → Standard
- <1だが>0.1アクセス/月 → IA
- <0.1だが>0.01アクセス/月 → Glacier
- <0.01アクセス/月 → Deep Archive

## 復旧戦略: レジリエンスの哲学

### 障害に関する存在論的思考

分散システムにおいて、障害は例外ではなく、常態です。異なるドメインの障害に対する哲学的態度が、災害復旧戦略の設計を決定します。

#### 金融取引: 障害のゼロトレランス哲学

**哲学的基盤**: 時は金なり、いかなる遅延も損失である

- RTO要件: < 30秒 (ユーザーはより長い待機に耐えられない)
- RPO要件: = 0 (取引データの損失は許容できない)

**AWS実装戦略**:

- マルチAZ RDS: 同期レプリケーション、自動フェイルオーバー
- DynamoDB Global Tables: マルチリージョン強整合性
- Lambda@Edge: エッジコンピューティングでレイテンシを削減
- Route 53: DNSフェイルオーバー、30秒以内に切り替え

**コストへの影響**: インフラストラクチャコストが200-300%増加

#### 家計管理: 障害の実用主義哲学

**哲学的基盤**: 人生は続く、完璧である必要はない

- RTO要件: < 4時間 (一般的に待機可能)
- RPO要件: < 1時間 (失われた記録は再入力可能)

**AWS実装戦略**:

- RDS自動バックアップ: 日次バックアップ、ポイントインタイム復旧
- S3クロスリージョンレプリケーション: リージョン間レプリケーション
- CloudFormation: Infrastructure as Codeで迅速な再構築
- SNS: 障害通知、ユーザーの期待値を設定

**コストへの影響**: インフラストラクチャコストが30-50%増加

#### 健康モニタリング: 治療より予防の哲学

**哲学的基盤**: 健康データは命に関わるが、継続性は完全性より重要

- RTO要件: < 2時間 (日常モニタリングに影響するが致命的ではない)
- RPO要件: < 30分 (短期的なデータ損失は許容可能)

**AWS実装戦略**:

- IoT Device Shadow: デバイス状態のローカルキャッシュ
- DynamoDBポイントインタイム復旧: 自動バックアップ
- Timestream: 時系列データの自動バックアップと圧縮
- CloudWatch: モニタリングとアラーム、問題の事前検出

**コストへの影響**: インフラストラクチャコストが50-80%増加

### 災害復旧アーキテクチャパターン

#### パイロットライトパターン: 最小限の実行可能バックアップ

**設計哲学**: コア機能のためのバックアップライト
**適用シナリオ**: 中程度のRTO要件、コスト敏感

**実装**:

- 重要なデータはバックアップリージョンに継続的にレプリケート
- コンピューティングリソースは最小構成に保持(または完全にオフ)
- 障害時には、迅速に起動してスケールアップ

**AWS実装**:

- RDSクロスリージョンリードレプリカ
- S3クロスリージョンレプリケーション
- AMI + Launch Templateの事前構成
- Route 53ヘルスチェックでフェイルオーバーをトリガー

**コスト特性**: 通常運用時は低コスト、フェイルオーバー時間は中程度

#### ウォームスタンバイパターン: ウォームバックアップのバランスの芸術

**設計哲学**: 常に準備できているが無駄ではない
**適用シナリオ**: より高いRTO要件、管理可能なコスト

**実装**:

- バックアップ環境は最小稼働状態に保持
- 重要なコンポーネントは起動しているが負荷は低い
- 障害時には、迅速にフル容量にスケールアップ

**AWS実装**:

- EC2インスタンスは稼働しているが小さいインスタンスタイプ
- Auto Scaling Group min=1, max=production_size
- ELBヘルスチェックで自動トラフィック切り替え
- Lambdaプリウォームコンテナでコールドスタートを回避

**コスト特性**: 継続的な運用コスト、しかしフェイルオーバーは高速

#### マルチサイトアクティブ-アクティブパターン: シームレスな完全冗長性

**設計哲学**: ダウンしない安心感
**適用シナリオ**: ゼロダウンタイム要件、コスト非敏感

**実装**:

- 複数のリージョンが同時にフルサービスを提供
- 負荷はすべてのサイト間で分散
- いずれかのサイトが障害を起こしても、他のサイトが透過的に引き継ぐ

**AWS実装**:

- Route 53レイテンシベースルーティング
- CloudFrontグローバル配信
- DynamoDB Global Tables
- マルチリージョンVPC Peering

**コスト特性**: 最高コスト、しかし最高のエクスペリエンス

## 6つのケースからの非機能要件の具体化

### ケース1: 投資取引システムの完全な技術仕様

**パフォーマンス要件**:

**APIレスポンスタイム**:

- 市場データクエリ: < 50ms (P99)
- 取引送信: < 100ms (P99)
- ポジションクエリ: < 200ms (P99)

**同時実行要件**:

- 通常期間: 500同時ユーザー
- 開場ピーク: 2000同時ユーザー
- システム制限: 5000同時ユーザー

**スループット**:

- 通常: 1000 RPS
- ピーク: 5000 RPS
- 緊急: 10000 RPS (5分以内)

**容量計画**:

**ユーザー成長予測**:

- 現在: 10,000アクティブユーザー
- 6ヶ月: 25,000アクティブユーザー
- 12ヶ月: 50,000アクティブユーザー

**データ成長**:

- ユーザーあたり1日あたり: 100KBの取引データ
- 年間成長率: 500GB/年
- 5年間の総容量: 2.5TB + 50%成長バッファ = 3.75TB

**コンピューティングリソース**:

- CPU集約型: リスク計算、テクニカル分析
- メモリ集約型: リアルタイムデータキャッシング
- ネットワーク集約型: 市場データ同期

**災害復旧**:

**主要メトリクス**:

- RTO: 30秒
- RPO: 0秒
- 可用性: 99.99% (年間8.76時間のダウンタイム)

**実装戦略**:

- プライマリ: us-east-1 (マルチAZ)
- セカンダリ: us-west-2 (ホットスタンバイ)
- データ: DynamoDB Global Tables + RDSリードレプリカ
- DNS: Route 53ヘルスチェック + 自動フェイルオーバー

### ケース6: 旅行共有プラットフォームの技術仕様比較

**パフォーマンス要件**:

**APIレスポンスタイム(取引システムとの比較)**:

- コンテンツアップロード: < 3秒 (取引の100msと比較して300倍緩い)
- ソーシャルインタラクション: < 1秒 (取引の50msと比較して20倍緩い)
- コンテンツブラウジング: < 500ms (取引の200msと比較して同様だがより高い許容度)

**同時実行パターン**:

- 作成ピーク: 週末の旅行期間
- ブラウジングピーク: 平日夜の共有期間
- 季節性: 旅行の閑散期と繁忙期で5〜10倍の差

**容量計画哲学の違い**:

**成長モデル**:

- 取引システム: 安定成長、予測可能な容量ニーズ
- 旅行システム: 爆発的成長、バイラル拡散の可能性

**データ特性**:

- 取引システム: 構造化データ、正確な計算
- 旅行システム: マルチメディアデータ、ストレージ集約型

**コスト敏感性**:

- 取引システム: パフォーマンス第一、コスト第二
- 旅行システム: コスト敏感、中程度のパフォーマンス

**災害復旧哲学**:

**データ価値**:

- 取引システム: すべての取引は金銭、損失は許容できない
- 旅行システム: クリエイティブコンテンツは再作成可能、損失の影響は限定的

**復旧戦略**:

- 取引システム: マルチAZ + リアルタイムバックアップ + ゼロRPO
- 旅行システム: クロスリージョンバックアップ + 定期スナップショット + 時間単位のRPO

**ユーザー期待**:

- 取引システム: プロフェッショナルツール、完璧な動作が基本要件
- 旅行システム: ライフスタイルツール、時折の障害は理解可能

## 明日の抽象モデリングのプレビュー

今日の技術的境界の確認を通じて、曖昧なビジネス要件から具体的な技術仕様を導き出しました。私たちは今、次のことを知っています:

- どれだけのRPS: ユーザー行動から導き出された定量的指標
- どれだけの容量: 成長パターンから予測されたストレージ要件
- どれだけの可用性: ビジネス価値によって決定される障害耐性

しかし、これらの技術仕様はまだ孤立した指標です。明日は「抽象モデリング」段階に入り、これらの技術的制約をシステムの概念モデル、行動モデル、データモデル、アーキテクチャモデルに変換する方法を学びます。

**主要な質問には以下が含まれます**:

- DDDの概念モデリングをAWSサービスにマッピングする方法は?
- EventStormingの行動モデリングでAPIフローを設計する方法は?
- データモデリングを使用してSQL vs NoSQLを決定する方法は?
- アーキテクチャモデリングを使用してサーバーレス vs コンテナのトレードオフを評価する方法は?

## 今日の技術哲学のまとめ

- 非機能要件は機能要件の定量的境界である
- RPSは推測ではなく、ユーザー行動から導き出された必然的な結果である
- 容量計画はビジネス成長パターンの技術的マッピングである
- 災害復旧戦略はドメインのリスクに対する哲学的態度を反映している

覚えておいてください: すべての技術指標にはそのビジネス的意味があります。私たちは技術指標を最適化しているのではなく、ユーザーの存在状態の変換の効率と信頼性を最適化しているのです。
